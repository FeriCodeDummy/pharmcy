name: CI


env:
  NODE_VERSION: 20
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/pharmacy
  GCP_REGION: europe-west10
  CLOUD_RUN_SERVICE: pharmacy
  CLOUDSQL_INSTANCE: ${{ secrets.CLOUDSQL_INSTANCE }}

on:
  push:
    branches: [main, production]

jobs:
  backend-tests:
    name: Backend tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run backend tests
        run: npm run test:backend

      - name: Upload backend coverage
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: coverage

  frontend-tests:
    name: Frontend tests
    runs-on: ubuntu-latest
    needs: backend-tests

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run frontend tests
        run: npm run test:frontend

      - name: Upload frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: coverage

  sonar:
    name: SonarCloud analysis
    runs-on: ubuntu-latest
    needs: [ backend-tests, frontend-tests ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: coverage

      - uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: coverage

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  build:
    name: Build (Next.js)
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload Next build artifact
        uses: actions/upload-artifact@v4
        with:
          name: next-build
          path: |
            .next
            public
            package.json
            package-lock.json
            next.config.*
    

  docker:
    name: Build & Push Docker image
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Choose image tag
        id: imgtag
        run: |
          if [ "${GITHUB_REF_NAME}" = "production" ]; then
            echo "tag=prod" >> $GITHUB_OUTPUT
          else
            echo "tag=dev" >> $GITHUB_OUTPUT
          fi
      

      - name: Docker metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ steps.imgtag.outputs.tag }}
            type=sha

      - name: Build & push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  quality-gate:
    name: SonarCloud Quality Gate
    runs-on: ubuntu-latest
    needs: sonar
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1.1.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        timeout-minutes: 5

  deploy-dev:
    if: github.ref_name == 'main'
    name: Deploy (Development)
    needs: docker
    runs-on: ubuntu-latest
    environment: Development
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      - name: Deploy dev
        run: |
          gcloud run deploy "${{ env.CLOUD_RUN_SERVICE }}" \
            --region "${{ env.GCP_REGION }}" \
            --image "docker.io/${{ env.IMAGE_NAME }}:dev" \
            --platform managed \
            --allow-unauthenticated \
            --add-cloudsql-instances "${{ env.CLOUDSQL_INSTANCE }}" \
            --set-env-vars "DB_SOCKET=/cloudsql/${{ env.CLOUDSQL_INSTANCE }},DB_USER=${{ secrets.DB_USER }},DB_PASSWORD=${{ secrets.DB_PASSWORD }},DB_NAME=${{ secrets.DB_NAME }}"

  deploy-prod:
    if: github.ref_name == 'production'
    name: Deploy (Production)
    needs: [docker, quality-gate]
    runs-on: ubuntu-latest
    environment: Production
    steps:
      - uses: actions/checkout@v4
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      - name: Deploy prod
        run: |
          gcloud run deploy "${{ env.CLOUD_RUN_SERVICE }}" \
            --region "${{ env.GCP_REGION }}" \
            --image "docker.io/${{ env.IMAGE_NAME }}:prod" \
            --platform managed \
            --allow-unauthenticated \
            --add-cloudsql-instances "${{ env.CLOUDSQL_INSTANCE }}" \
            --set-env-vars "DB_SOCKET=/cloudsql/${{ env.CLOUDSQL_INSTANCE }},DB_USER=${{ secrets.DB_USER }},DB_PASSWORD=${{ secrets.DB_PASSWORD }},DB_NAME=${{ secrets.DB_NAME }}"